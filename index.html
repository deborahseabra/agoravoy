<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora A/B Test</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #FFF8ED; --surface: #FFFFFF; --surface-2: #FFF3DC;
    --border: #F0DFC4; --accent: #E8752A;
    --accent-dim: rgba(232,117,42,.08); --accent-glow: rgba(232,117,42,.15);
    --purple: #2D1B4E; --text: #2D1B4E;
    --text-secondary: #6B5A7E; --text-muted: #9B8EAB;
    --green: #2E8B57; --green-bg: rgba(46,139,87,.08);
    --red: #C0392B; --red-bg: rgba(192,57,43,.08);
    --radius: 14px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text);
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center;
    padding:32px 24px;
  }
  .container { width:100%; max-width:520px; }
  .header { margin-bottom:24px; }
  .header h1 {
    font-family:'Fraunces',serif; font-weight:500; font-size:28px;
    letter-spacing:-.5px; margin-bottom:6px; color:var(--purple);
  }
  .header h1 span { color:var(--accent); }
  .header p { color:var(--text-secondary); font-size:13px; line-height:1.5; }

  /* Tabs */
  .mode-tabs {
    display:flex; background:var(--surface); border:1.5px solid var(--border);
    border-radius:10px; padding:3px; margin-bottom:14px; gap:3px;
  }
  .mode-tab {
    flex:1; padding:9px 6px; text-align:center; font-size:11px; font-weight:600;
    color:var(--text-secondary); cursor:pointer; border-radius:8px; transition:all .2s;
    border:none; background:none; font-family:'DM Sans',sans-serif; line-height:1.3;
  }
  .mode-tab:hover { color:var(--accent); }
  .mode-tab.active {
    background:var(--purple); color:#fff; font-weight:700;
    box-shadow:0 2px 6px rgba(45,27,78,.12);
  }

  /* Card */
  .card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; margin-bottom:14px;
    box-shadow:0 1px 3px rgba(45,27,78,.04);
  }
  .field { margin-bottom:16px; }
  .field:last-child { margin-bottom:0; }
  .field-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .field-row-3 { display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end; }

  label {
    display:block; font-size:11px; font-weight:700; text-transform:uppercase;
    letter-spacing:.7px; color:var(--purple); margin-bottom:6px;
  }
  label .hint { text-transform:none; letter-spacing:0; color:var(--text-muted); font-weight:400; }

  input[type="number"] {
    width:100%; background:var(--surface-2); border:1.5px solid var(--border);
    border-radius:8px; padding:10px 12px; font-family:'DM Sans',sans-serif;
    font-size:15px; color:var(--text); outline:none; transition:border-color .2s,box-shadow .2s;
    -moz-appearance:textfield;
  }
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button { -webkit-appearance:none; }
  input[type="number"]:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
  input[type="number"]::placeholder { color:var(--text-muted); }

  .suffix-wrap { position:relative; }
  .suffix-wrap .suffix {
    position:absolute; right:12px; top:50%; transform:translateY(-50%);
    color:var(--text-muted); font-size:13px; pointer-events:none;
  }
  .suffix-wrap input { padding-right:38px; }

  .mini-toggle {
    display:inline-flex; background:var(--surface-2); border:1.5px solid var(--border);
    border-radius:8px; overflow:hidden; height:40px;
  }
  .mini-toggle-opt { position:relative; }
  .mini-toggle-opt input { position:absolute; opacity:0; width:0; height:0; }
  .mini-toggle-opt label {
    display:flex; align-items:center; justify-content:center;
    padding:0 12px; height:100%; font-size:12px; font-weight:600;
    color:var(--text-muted); cursor:pointer; transition:all .2s;
    text-transform:none; letter-spacing:0; margin-bottom:0; white-space:nowrap;
  }
  .mini-toggle-opt input:checked+label { background:var(--purple); color:#fff; }

  .ci-selector { display:flex; gap:6px; }
  .ci-option { flex:1; position:relative; }
  .ci-option input { position:absolute; opacity:0; width:0; height:0; }
  .ci-option label {
    display:flex; align-items:center; justify-content:center;
    padding:8px 6px; background:var(--surface-2); border:1.5px solid var(--border);
    border-radius:8px; font-size:13px; font-weight:500; color:var(--text-secondary);
    cursor:pointer; transition:all .2s; text-transform:none; letter-spacing:0; margin-bottom:0;
  }
  .ci-option input:checked+label {
    background:var(--accent); border-color:var(--accent); color:#fff; font-weight:700;
  }
  .ci-option label:hover { border-color:var(--accent); color:var(--accent); }

  .test-toggle {
    display:flex; background:var(--surface-2); border-radius:8px;
    border:1.5px solid var(--border); overflow:hidden;
  }
  .test-toggle-option { flex:1; position:relative; }
  .test-toggle-option input { position:absolute; opacity:0; width:0; height:0; }
  .test-toggle-option label {
    display:flex; align-items:center; justify-content:center;
    padding:8px; font-size:12px; font-weight:500; color:var(--text-secondary);
    cursor:pointer; transition:all .2s; text-transform:none; letter-spacing:0;
    margin-bottom:0; border-radius:0;
  }
  .test-toggle-option input:checked+label { background:var(--purple); color:#fff; font-weight:700; }

  .computed-preview {
    margin-top:6px; padding:8px 12px; background:var(--accent-dim);
    border-radius:6px; border:1px solid rgba(232,117,42,.12);
    font-size:12px; color:var(--accent); display:none;
  }
  .computed-preview strong { font-weight:700; }

  /* Result */
  .result-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px; text-align:center;
    position:relative; overflow:hidden; box-shadow:0 1px 3px rgba(45,27,78,.04);
  }
  .result-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg,var(--accent),var(--purple));
    opacity:0; transition:opacity .4s;
  }
  .result-card.active::before { opacity:1; }
  .result-label {
    font-size:11px; text-transform:uppercase; letter-spacing:.8px;
    color:var(--text-secondary); margin-bottom:10px; font-weight:700;
  }
  .result-value {
    font-family:'Fraunces',serif; font-size:48px; font-weight:700;
    color:var(--accent); letter-spacing:-1px; line-height:1; margin-bottom:4px;
  }
  .result-subtitle { font-size:12px; color:var(--text-muted); margin-bottom:16px; }
  .result-details {
    display:grid; grid-template-columns:1fr 1fr; gap:10px;
    margin-top:14px; padding-top:14px; border-top:1px solid var(--border);
  }
  .result-details.three-col { grid-template-columns:1fr 1fr 1fr; }
  .detail-item { text-align:center; }
  .detail-item .detail-value {
    font-family:'Fraunces',serif; font-size:20px; font-weight:700;
    color:var(--purple); margin-bottom:1px;
  }
  .detail-item .detail-label {
    font-size:10px; text-transform:uppercase; letter-spacing:.5px;
    color:var(--text-muted); font-weight:500;
  }

  .sig-badge {
    display:inline-flex; align-items:center; gap:5px; padding:6px 14px;
    border-radius:16px; font-size:12px; font-weight:700; margin-top:12px;
  }
  .sig-badge.significant { background:var(--green-bg); color:var(--green); border:1px solid rgba(46,139,87,.2); }
  .sig-badge.not-significant { background:var(--red-bg); color:var(--red); border:1px solid rgba(192,57,43,.2); }

  .formula-note {
    margin-top:12px; padding:10px 12px; background:var(--surface-2);
    border-radius:8px; border:1px solid var(--border); font-size:11px;
    color:var(--text-muted); line-height:1.5; text-align:left;
  }
  .formula-note code {
    color:var(--purple); background:#fff; padding:1px 4px; border-radius:3px; font-size:10px; font-weight:500;
  }

  .use-case-hint {
    font-size:11px; color:var(--text-muted); margin-top:8px; padding:0 2px; line-height:1.4;
  }

  .panel { display:none; }
  .panel.active { display:block; }

  @media (max-width:500px) {
    .field-row, .field-row-3 { grid-template-columns:1fr; gap:10px; }
    .result-value { font-size:36px; }
    .result-details.three-col { grid-template-columns:1fr; gap:6px; }
    .mode-tab { font-size:10px; padding:8px 4px; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>A/B Test <span>Calculator</span></h1>
    <p>Planeje o sample size ou analise resultados do seu experimento.</p>
  </div>

  <div class="mode-tabs">
    <button class="mode-tab active" onclick="switchMode('plan')">üìê Planejar<br>sample size</button>
    <button class="mode-tab" onclick="switchMode('analyze')">üîç Analisar<br>propor√ß√µes</button>
    <button class="mode-tab" onclick="switchMode('ttest')">üìä Comparar<br>m√©dias</button>
  </div>

  <!-- ===== PANEL 1: PLAN ===== -->
  <div class="panel active" id="panel-plan">
    <div class="card">
      <div class="field">
        <div class="field-row">
          <div>
            <label>Tipo de teste</label>
            <div class="test-toggle">
              <div class="test-toggle-option">
                <input type="radio" name="p_test" id="p_two" value="two" checked>
                <label for="p_two">Bicaudal</label>
              </div>
              <div class="test-toggle-option">
                <input type="radio" name="p_test" id="p_one" value="one">
                <label for="p_one">Unicaudal</label>
              </div>
            </div>
          </div>
          <div>
            <label>Confian√ßa</label>
            <div class="ci-selector">
              <div class="ci-option"><input type="radio" name="p_ci" id="p_ci90" value="90"><label for="p_ci90">90</label></div>
              <div class="ci-option"><input type="radio" name="p_ci" id="p_ci95" value="95" checked><label for="p_ci95">95</label></div>
              <div class="ci-option"><input type="radio" name="p_ci" id="p_ci99" value="99"><label for="p_ci99">99</label></div>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <div class="field-row-3">
          <div>
            <label>Taxa base (B)</label>
            <div class="suffix-wrap">
              <input type="number" id="p_baseline" placeholder="54" step="0.1" min="0.01" max="99.99" value="54">
              <span class="suffix">%</span>
            </div>
          </div>
          <div>
            <label id="p_uplift_label">Varia√ß√£o esperada</label>
            <div class="suffix-wrap">
              <input type="number" id="p_uplift" placeholder="5" step="0.5" value="5">
              <span class="suffix" id="p_uplift_suffix">p.p.</span>
            </div>
          </div>
          <div>
            <label style="visibility:hidden;">_</label>
            <div class="mini-toggle">
              <div class="mini-toggle-opt">
                <input type="radio" name="p_umode" id="p_umode_pp" value="pp" checked>
                <label for="p_umode_pp">p.p.</label>
              </div>
              <div class="mini-toggle-opt">
                <input type="radio" name="p_umode" id="p_umode_rel" value="relative">
                <label for="p_umode_rel">%</label>
              </div>
            </div>
          </div>
        </div>
        <div class="computed-preview" id="p_preview"></div>
      </div>
    </div>
    <div class="result-card" id="planResult">
      <div class="result-label">Amostra por grupo</div>
      <div class="result-value" id="planValue">‚Äî</div>
      <div class="result-subtitle" id="planSubtitle">Preencha os campos acima</div>
      <div class="result-details" id="planDetails" style="display:none;">
        <div class="detail-item">
          <div class="detail-value" id="planTotal">‚Äî</div>
          <div class="detail-label">Total (A + B)</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="planExpected">‚Äî</div>
          <div class="detail-label">Taxa esperada (A)</div>
        </div>
      </div>
      <div class="formula-note">
        Evan Miller: <code>n = (ZŒ±¬∑‚àö(2p‚ÇÅq‚ÇÅ) + ZŒ≤¬∑‚àö(p‚ÇÅq‚ÇÅ+p‚ÇÇq‚ÇÇ))¬≤ / (p‚ÇÇ‚àíp‚ÇÅ)¬≤</code> ¬∑ Poder fixo em 80%
      </div>
    </div>
  </div>

  <!-- ===== PANEL 2: ANALYZE PROPORTIONS ===== -->
  <div class="panel" id="panel-analyze">
    <div class="card">
      <div class="field">
        <div class="field-row">
          <div>
            <label>Tipo de teste</label>
            <div class="test-toggle">
              <div class="test-toggle-option">
                <input type="radio" name="a_test" id="a_two" value="two" checked>
                <label for="a_two">Bicaudal</label>
              </div>
              <div class="test-toggle-option">
                <input type="radio" name="a_test" id="a_one" value="one">
                <label for="a_one">Unicaudal</label>
              </div>
            </div>
          </div>
          <div>
            <label>Entrada</label>
            <div class="test-toggle">
              <div class="test-toggle-option">
                <input type="radio" name="a_mode" id="a_mode_abs" value="absolute" checked>
                <label for="a_mode_abs"># absoluto</label>
              </div>
              <div class="test-toggle-option">
                <input type="radio" name="a_mode" id="a_mode_pct" value="percent">
                <label for="a_mode_pct">Taxa %</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <div class="field-row">
          <div>
            <label>Amostra B <span class="hint">‚Äî controle</span></label>
            <input type="number" id="a_nB" placeholder="5000" min="1" value="5000">
          </div>
          <div>
            <label>Amostra A <span class="hint">‚Äî variante</span></label>
            <input type="number" id="a_nA" placeholder="5000" min="1" value="5000">
          </div>
        </div>
      </div>
      <div class="field">
        <div class="field-row">
          <div>
            <label id="a_convB_label">Convers√µes B</label>
            <div class="suffix-wrap">
              <input type="number" id="a_convB" placeholder="250" min="0" value="250">
              <span class="suffix" id="a_convB_suffix"></span>
            </div>
          </div>
          <div>
            <label id="a_convA_label">Convers√µes A</label>
            <div class="suffix-wrap">
              <input type="number" id="a_convA" placeholder="300" min="0" value="300">
              <span class="suffix" id="a_convA_suffix"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="use-case-hint">Use para: taxas de convers√£o, reten√ß√£o, churn, CTR</div>
    <div class="result-card" id="analyzeResult" style="margin-top:8px;">
      <div class="result-label">Confian√ßa observada</div>
      <div class="result-value" id="analyzeValue">‚Äî</div>
      <div class="result-subtitle" id="analyzeSubtitle">Preencha os campos acima</div>
      <div id="analyzeBadge"></div>
      <div class="result-details three-col" id="analyzeDetails" style="display:none;">
        <div class="detail-item">
          <div class="detail-value" id="analyzeRateB">‚Äî</div>
          <div class="detail-label">Taxa B</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="analyzeRateA">‚Äî</div>
          <div class="detail-label">Taxa A</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="analyzeUplift">‚Äî</div>
          <div class="detail-label">Varia√ß√£o</div>
        </div>
      </div>
      <div class="formula-note" style="margin-top:12px;">
        <code>Z = (pA ‚àí pB) / ‚àö(pÃÇ(1‚àípÃÇ)(1/nA+1/nB))</code> ‚Üí p-valor ‚Üí confian√ßa
      </div>
    </div>
  </div>

  <!-- ===== PANEL 3: T-TEST (compare means) ===== -->
  <div class="panel" id="panel-ttest">
    <div class="card">
      <div class="field">
        <div class="field-row">
          <div>
            <label>Tipo de teste</label>
            <div class="test-toggle">
              <div class="test-toggle-option">
                <input type="radio" name="t_test" id="t_two" value="two" checked>
                <label for="t_two">Bicaudal</label>
              </div>
              <div class="test-toggle-option">
                <input type="radio" name="t_test" id="t_one" value="one">
                <label for="t_one">Unicaudal</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <div class="field-row">
          <div style="text-align:center;">
            <label style="margin-bottom:12px;">Grupo B <span class="hint">‚Äî controle</span></label>
          </div>
          <div style="text-align:center;">
            <label style="margin-bottom:12px;">Grupo A <span class="hint">‚Äî variante</span></label>
          </div>
        </div>
        <div class="field-row" style="margin-bottom:10px;">
          <div>
            <label>M√©dia B</label>
            <input type="number" id="t_meanB" placeholder="4.61" step="0.01" value="4.61">
          </div>
          <div>
            <label>M√©dia A</label>
            <input type="number" id="t_meanA" placeholder="4.67" step="0.01" value="4.67">
          </div>
        </div>
        <div class="field-row" style="margin-bottom:10px;">
          <div>
            <label>Desvio padr√£o B</label>
            <input type="number" id="t_sdB" placeholder="0.5" step="0.01" min="0.001" value="0.5">
          </div>
          <div>
            <label>Desvio padr√£o A</label>
            <input type="number" id="t_sdA" placeholder="0.5" step="0.01" min="0.001" value="0.5">
          </div>
        </div>
        <div class="field-row">
          <div>
            <label>Amostra B (n)</label>
            <input type="number" id="t_nB" placeholder="816" min="2" value="816">
          </div>
          <div>
            <label>Amostra A (n)</label>
            <input type="number" id="t_nA" placeholder="166" min="2" value="166">
          </div>
        </div>
      </div>
    </div>
    <div class="use-case-hint">Use para: CSAT, NPS, nota m√©dia, tempo de resposta, ticket m√©dio</div>
    <div class="result-card" id="ttestResult" style="margin-top:8px;">
      <div class="result-label">Confian√ßa observada</div>
      <div class="result-value" id="ttestValue">‚Äî</div>
      <div class="result-subtitle" id="ttestSubtitle">Preencha os campos acima</div>
      <div id="ttestBadge"></div>
      <div class="result-details three-col" id="ttestDetails" style="display:none;">
        <div class="detail-item">
          <div class="detail-value" id="ttestMeanB">‚Äî</div>
          <div class="detail-label">M√©dia B</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="ttestMeanA">‚Äî</div>
          <div class="detail-label">M√©dia A</div>
        </div>
        <div class="detail-item">
          <div class="detail-value" id="ttestDiff">‚Äî</div>
          <div class="detail-label">Diferen√ßa</div>
        </div>
      </div>
      <div class="formula-note" style="margin-top:12px;">
        Welch's t-test: <code>t = (xÃÑA ‚àí xÃÑB) / ‚àö(s¬≤A/nA + s¬≤B/nB)</code> ‚Üí p-valor ‚Üí confian√ßa
      </div>
    </div>
  </div>
</div>

<script>
  const POWER = 0.80;

  // ===== Math =====
  function invNorm(p) {
    if (p <= 0) return -Infinity; if (p >= 1) return Infinity; if (p === 0.5) return 0;
    let t = p < 0.5 ? Math.sqrt(-2 * Math.log(p)) : Math.sqrt(-2 * Math.log(1 - p));
    let z = t - (2.515517 + 0.802853*t + 0.010328*t*t) / (1 + 1.432788*t + 0.189269*t*t + 0.001308*t*t*t);
    return p < 0.5 ? -z : z;
  }

  function normCDF(x) {
    if (x === Infinity) return 1; if (x === -Infinity) return 0;
    const s = x < 0 ? -1 : 1; x = Math.abs(x) / Math.SQRT2;
    const t = 1 / (1 + 0.3275911 * x);
    const y = 1 - ((((1.061405429*t - 1.453152027)*t + 1.421413741)*t - 0.284496736)*t + 0.254829592) * t * Math.exp(-x * x);
    return 0.5 * (1 + s * y);
  }

  // t-distribution CDF approximation (Abramowitz & Stegun 26.7.5 via normal approx for large df)
  // For df > 30, t-distribution ‚âà normal. For smaller df, use better approx.
  function tCDF(t, df) {
    // Hill's 1970 approximation ‚Äî accurate for all df
    const x = df / (df + t * t);
    const prob = 0.5 * incompleteBeta(df / 2, 0.5, x);
    return t >= 0 ? 1 - prob : prob;
  }

  // Regularized incomplete beta function via continued fraction (Lentz's method)
  function incompleteBeta(a, b, x) {
    if (x === 0) return 0;
    if (x === 1) return 1;

    const lnBeta = lgamma(a) + lgamma(b) - lgamma(a + b);
    const front = Math.exp(Math.log(x) * a + Math.log(1 - x) * b - lnBeta);

    // Lentz's continued fraction
    let f = 1, c = 1, d = 1 - (a + b) * x / (a + 1);
    if (Math.abs(d) < 1e-30) d = 1e-30;
    d = 1 / d; f = d;

    for (let i = 1; i <= 200; i++) {
      let m = i, numerator;
      // Even step
      numerator = m * (b - m) * x / ((a + 2*m - 1) * (a + 2*m));
      d = 1 + numerator * d; if (Math.abs(d) < 1e-30) d = 1e-30; d = 1/d;
      c = 1 + numerator / c; if (Math.abs(c) < 1e-30) c = 1e-30;
      f *= d * c;
      // Odd step
      numerator = -(a + m) * (a + b + m) * x / ((a + 2*m) * (a + 2*m + 1));
      d = 1 + numerator * d; if (Math.abs(d) < 1e-30) d = 1e-30; d = 1/d;
      c = 1 + numerator / c; if (Math.abs(c) < 1e-30) c = 1e-30;
      f *= d * c;
      if (Math.abs(d * c - 1) < 1e-10) break;
    }
    return front / a * f;
  }

  // Log-gamma (Stirling's approx + Lanczos)
  function lgamma(x) {
    const g = 7;
    const coef = [0.99999999999980993, 676.5203681218851, -1259.1392167224028,
      771.32342877765313, -176.61502916214059, 12.507343278686905,
      -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
    if (x < 0.5) return Math.log(Math.PI / Math.sin(Math.PI * x)) - lgamma(1 - x);
    x -= 1;
    let a = coef[0];
    for (let i = 1; i < g + 2; i++) a += coef[i] / (x + i);
    const t = x + g + 0.5;
    return 0.5 * Math.log(2 * Math.PI) + (x + 0.5) * Math.log(t) - t + Math.log(a);
  }

  // Welch-Satterthwaite degrees of freedom
  function welchDF(s1, n1, s2, n2) {
    const v1 = s1*s1/n1, v2 = s2*s2/n2;
    return Math.pow(v1 + v2, 2) / (v1*v1/(n1-1) + v2*v2/(n2-1));
  }

  // ===== Tab switching =====
  function switchMode(m) {
    const modes = ['plan', 'analyze', 'ttest'];
    document.querySelectorAll('.mode-tab').forEach((t, i) =>
      t.classList.toggle('active', modes[i] === m));
    modes.forEach(id =>
      document.getElementById('panel-' + id).classList.toggle('active', id === m));
  }

  // ===== PLAN =====
  function updateUpliftUI() {
    const mode = document.querySelector('input[name="p_umode"]:checked').value;
    document.getElementById('p_uplift_label').textContent = mode === 'pp' ? 'Varia√ß√£o esperada' : 'Varia√ß√£o relativa';
    document.getElementById('p_uplift_suffix').textContent = mode === 'pp' ? 'p.p.' : '%';
    calcPlan();
  }

  function calcPlan() {
    const base = parseFloat(document.getElementById('p_baseline').value);
    const raw = parseFloat(document.getElementById('p_uplift').value);
    const umode = document.querySelector('input[name="p_umode"]:checked').value;
    const ci = parseInt(document.querySelector('input[name="p_ci"]:checked').value);
    const tails = document.querySelector('input[name="p_test"]:checked').value;
    const card = document.getElementById('planResult'), val = document.getElementById('planValue');
    const sub = document.getElementById('planSubtitle'), det = document.getElementById('planDetails');
    const preview = document.getElementById('p_preview');

    if (isNaN(base) || isNaN(raw) || base <= 0 || base >= 100 || raw === 0) {
      val.textContent = '‚Äî'; sub.textContent = 'Preencha os campos';
      det.style.display = 'none'; preview.style.display = 'none'; card.classList.remove('active'); return;
    }
    const p1 = base / 100;
    const p2 = umode === 'pp' ? p1 + raw / 100 : p1 * (1 + raw / 100);
    if (p2 >= 1 || p2 <= 0) {
      val.textContent = '‚Äî'; sub.textContent = 'Taxa resultante fora do intervalo (0%‚Äì100%)';
      det.style.display = 'none'; preview.style.display = 'none'; card.classList.remove('active'); return;
    }

    const isNeg = p2 < p1, arrow = isNeg ? '‚Üì' : '‚Üë';
    if (umode === 'pp') {
      const rel = ((p2 - p1) / p1 * 100).toFixed(1);
      preview.innerHTML = `${arrow} <strong>${(p1*100).toFixed(1)}%</strong> ‚Üí <strong>${(p2*100).toFixed(1)}%</strong> (${rel > 0 ? '+' : ''}${rel}% relativo)`;
    } else {
      const pp = ((p2 - p1) * 100).toFixed(1);
      preview.innerHTML = `${arrow} <strong>${(p1*100).toFixed(1)}%</strong> ‚Üí <strong>${(p2*100).toFixed(1)}%</strong> (${pp > 0 ? '+' : ''}${pp} p.p.)`;
    }
    preview.style.display = 'block';

    const alpha = tails === 'two' ? (1 - ci / 100) / 2 : (1 - ci / 100);
    const za = invNorm(1 - alpha), zb = invNorm(POWER);
    const delta = Math.abs(p2 - p1);
    const sd1 = Math.sqrt(2 * p1 * (1 - p1));
    const sd2 = Math.sqrt(p1 * (1 - p1) + p2 * (1 - p2));
    const n = Math.ceil(Math.pow(za * sd1 + zb * sd2, 2) / (delta * delta));

    val.textContent = n.toLocaleString('pt-BR');
    const sign = raw > 0 ? '+' : '', unit = umode === 'pp' ? 'p.p.' : '% relativo';
    const verb = isNeg ? 'redu√ß√£o' : 'aumento';
    sub.textContent = `por grupo ‚Äî para detectar ${verb} de ${sign}${raw} ${unit}`;
    det.style.display = 'grid'; card.classList.add('active');
    document.getElementById('planTotal').textContent = (n * 2).toLocaleString('pt-BR');
    document.getElementById('planExpected').textContent = (p2 * 100).toFixed(2) + '%';
  }

  ['p_baseline', 'p_uplift'].forEach(id => document.getElementById(id).addEventListener('input', calcPlan));
  ['p_ci', 'p_test'].forEach(n => document.querySelectorAll(`input[name="${n}"]`).forEach(r => r.addEventListener('change', calcPlan)));
  document.querySelectorAll('input[name="p_umode"]').forEach(r => r.addEventListener('change', updateUpliftUI));
  calcPlan();

  // ===== ANALYZE PROPORTIONS =====
  function updateAnalyzeUI() {
    const mode = document.querySelector('input[name="a_mode"]:checked').value;
    if (mode === 'percent') {
      document.getElementById('a_convB_label').innerHTML = 'Taxa B <span class="hint">‚Äî controle</span>';
      document.getElementById('a_convA_label').innerHTML = 'Taxa A <span class="hint">‚Äî variante</span>';
      document.getElementById('a_convB_suffix').textContent = '%';
      document.getElementById('a_convA_suffix').textContent = '%';
    } else {
      document.getElementById('a_convB_label').innerHTML = 'Convers√µes B';
      document.getElementById('a_convA_label').innerHTML = 'Convers√µes A';
      document.getElementById('a_convB_suffix').textContent = '';
      document.getElementById('a_convA_suffix').textContent = '';
    }
    calcAnalyze();
  }

  function calcAnalyze() {
    const nB = parseFloat(document.getElementById('a_nB').value);
    const nA = parseFloat(document.getElementById('a_nA').value);
    const cB = parseFloat(document.getElementById('a_convB').value);
    const cA = parseFloat(document.getElementById('a_convA').value);
    const tails = document.querySelector('input[name="a_test"]:checked').value;
    const mode = document.querySelector('input[name="a_mode"]:checked').value;
    const card = document.getElementById('analyzeResult'), val = document.getElementById('analyzeValue');
    const sub = document.getElementById('analyzeSubtitle'), det = document.getElementById('analyzeDetails');
    const badge = document.getElementById('analyzeBadge');

    if (isNaN(nB) || isNaN(nA) || isNaN(cB) || isNaN(cA) || nB <= 0 || nA <= 0) {
      val.textContent = '‚Äî'; sub.textContent = 'Preencha os campos';
      det.style.display = 'none'; badge.innerHTML = ''; card.classList.remove('active'); return;
    }
    let pB, pA;
    if (mode === 'percent') { pB = cB / 100; pA = cA / 100; } else { pB = cB / nB; pA = cA / nA; }
    if (pB < 0 || pB > 1 || pA < 0 || pA > 1) {
      val.textContent = '‚Äî'; sub.textContent = 'Taxas entre 0% e 100%';
      det.style.display = 'none'; badge.innerHTML = ''; card.classList.remove('active'); return;
    }
    const pool = (pB * nB + pA * nA) / (nB + nA);
    const se = Math.sqrt(pool * (1 - pool) * (1 / nB + 1 / nA));
    if (se === 0) {
      val.textContent = '‚Äî'; sub.textContent = 'Sem vari√¢ncia';
      det.style.display = 'none'; badge.innerHTML = ''; card.classList.remove('active'); return;
    }
    const z = (pA - pB) / se;
    let pVal = tails === 'two' ? 2 * (1 - normCDF(Math.abs(z))) : (z > 0 ? 1 - normCDF(z) : normCDF(z));
    const conf = (1 - pVal) * 100;
    const uplift = pB > 0 ? (pA - pB) / pB * 100 : 0;

    val.textContent = conf.toFixed(1) + '%';
    sub.textContent = `p-valor: ${pVal < 0.0001 ? '< 0.0001' : pVal.toFixed(4)} ¬∑ Z: ${z.toFixed(3)}`;
    det.style.display = 'grid'; card.classList.add('active');
    document.getElementById('analyzeRateB').textContent = (pB * 100).toFixed(2) + '%';
    document.getElementById('analyzeRateA').textContent = (pA * 100).toFixed(2) + '%';
    document.getElementById('analyzeUplift').textContent = (uplift >= 0 ? '+' : '') + uplift.toFixed(2) + '%';
    const isSig = pVal < 0.05;
    badge.innerHTML = `<div class="sig-badge ${isSig ? 'significant' : 'not-significant'}">
      ${isSig ? '‚úì Significativo (p < 0.05)' : '‚úó N√£o significativo (p ‚â• 0.05)'}</div>`;
  }

  ['a_nB', 'a_nA', 'a_convB', 'a_convA'].forEach(id => document.getElementById(id).addEventListener('input', calcAnalyze));
  ['a_test', 'a_mode'].forEach(n => document.querySelectorAll(`input[name="${n}"]`).forEach(r => r.addEventListener('change', n === 'a_mode' ? updateAnalyzeUI : calcAnalyze)));
  calcAnalyze();

  // ===== T-TEST (compare means) =====
  function calcTTest() {
    const meanB = parseFloat(document.getElementById('t_meanB').value);
    const meanA = parseFloat(document.getElementById('t_meanA').value);
    const sdB = parseFloat(document.getElementById('t_sdB').value);
    const sdA = parseFloat(document.getElementById('t_sdA').value);
    const nB = parseFloat(document.getElementById('t_nB').value);
    const nA = parseFloat(document.getElementById('t_nA').value);
    const tails = document.querySelector('input[name="t_test"]:checked').value;

    const card = document.getElementById('ttestResult'), val = document.getElementById('ttestValue');
    const sub = document.getElementById('ttestSubtitle'), det = document.getElementById('ttestDetails');
    const badge = document.getElementById('ttestBadge');

    if (isNaN(meanB) || isNaN(meanA) || isNaN(sdB) || isNaN(sdA) || isNaN(nB) || isNaN(nA) ||
        sdB <= 0 || sdA <= 0 || nB < 2 || nA < 2) {
      val.textContent = '‚Äî'; sub.textContent = 'Preencha os campos (n ‚â• 2, sd > 0)';
      det.style.display = 'none'; badge.innerHTML = ''; card.classList.remove('active'); return;
    }

    // Welch's t-test (does not assume equal variances)
    const se = Math.sqrt(sdA*sdA/nA + sdB*sdB/nB);
    if (se === 0) {
      val.textContent = '‚Äî'; sub.textContent = 'Sem vari√¢ncia';
      det.style.display = 'none'; badge.innerHTML = ''; card.classList.remove('active'); return;
    }

    const t = (meanA - meanB) / se;
    const df = welchDF(sdA, nA, sdB, nB);

    // p-value from t-distribution
    let pVal;
    if (tails === 'two') {
      pVal = 2 * (1 - tCDF(Math.abs(t), df));
    } else {
      pVal = t > 0 ? 1 - tCDF(t, df) : tCDF(t, df);
    }
    // Clamp
    if (pVal < 0) pVal = 0;

    const conf = (1 - pVal) * 100;
    const diff = meanA - meanB;

    val.textContent = conf.toFixed(1) + '%';
    sub.textContent = `p-valor: ${pVal < 0.0001 ? '< 0.0001' : pVal.toFixed(4)} ¬∑ t: ${t.toFixed(3)} ¬∑ gl: ${Math.round(df)}`;
    det.style.display = 'grid'; card.classList.add('active');
    document.getElementById('ttestMeanB').textContent = meanB.toFixed(2);
    document.getElementById('ttestMeanA').textContent = meanA.toFixed(2);
    document.getElementById('ttestDiff').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(2);
    const isSig = pVal < 0.05;
    badge.innerHTML = `<div class="sig-badge ${isSig ? 'significant' : 'not-significant'}">
      ${isSig ? '‚úì Significativo (p < 0.05)' : '‚úó N√£o significativo (p ‚â• 0.05)'}</div>`;
  }

  ['t_meanB', 't_meanA', 't_sdB', 't_sdA', 't_nB', 't_nA'].forEach(id =>
    document.getElementById(id).addEventListener('input', calcTTest));
  document.querySelectorAll('input[name="t_test"]').forEach(r => r.addEventListener('change', calcTTest));
  calcTTest();
</script>
</body>
</html>
